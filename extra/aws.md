# AWS

생활코딩의 아마존 웹서비스(AWS) 강의를 듣고...

## 아마존 웹서비스와 클라우드 컴퓨팅

클라우드 컴퓨팅이란, 로컬 컴퓨터를 (어딘가에 있는, 여러대의 컴퓨터가 연결되어 있는) 거대한 컴퓨터와 인터넷으로 연결하여
내 컴퓨터에서 처리하고자 하는 것을 거대한 컴퓨터에서 처리하고 그 결과값을 인터넷으로 내려받는 형식을 말한다.
핵심은 인터넷이며, 인터넷에 연결되어 있는 컴퓨터를 사용한다는 것이 본질이다.
인터넷으로 다른 거대한 컴퓨터와 연결되어 있는 것을 구름(클라우드)로 표현한 것이다.

아마존이 대표적으로 클라우드 컴퓨팅 서비스를 제공하고 있으며, 기반 기능과 IT 트랜드에 맞춰서 추가된 여러 기능들을 제공하고 있다.

## 회원가입

아마존 웹 서비스는 기업용 서비스로서 비용이 지불되는 서비스이므로 비밀번호는 신중하게 입력할 것!
해킹의 위험이 있기 때문에 평소에 사용하지 않는 어려운 비밀번호로 지정할 것!!

## 보안설정 - 2단계 인증

루트계정에서 MFA 활성화를 한다.
MFA는 다요소 인증(Multi-factor Authentication)의 줄임말이다. ex) OTP, TOTP 등...
MFA를 활성화 하면 로그인 시 비밀번호를 입력하고 추가로 다른 방식으로 인증을 해야 로그인이 가능하다.

IMA > 보안 자격 증명 > 멀티 팩터 인증(MFA) > MFA 활성화 버튼 클릭

인증 방법으로
Google OTP 추천 : 안드로이드와 ios에서도 사용 가능 ex) Google OTP, Google Authentication으로 검색

다만, GoogleOTP를 선택해서 기기를 변경했거나, 분실, 손상 됐을 경우에는 문의를 해야함.
id/pw로 로그인하면 오른편에 문의하기 버튼이 있음.
복원하려면 절차가 복잡하니 2단계 인증은 관리를 잘 할 것!
(강사님의 설명대로라면 몇시간~하루 뒤에 구글에서 전화가 옴. aws에 가입한 이메일 계정으로 코드를 하나 보냈으니 해당 코드를 말해달라고 함. 모든건 영어로 대화가 이루어짐.)

## 지역과 가용구역

AWS의 인프라가 위치하고 있는 공간에 대해 지역(Region)과 가용구역(avaliability zone)으로 구분할 수 있다.

### 지역(Region)

아마존 웹 서비스가 보유하고 있는 컴퓨터가 어디에 위치하고 있는가를 의미한다.
사이트를 사용하는 고객이 위치하고 있는 곳과 가상 컴퓨터의 위치가 멀면 멀수록 네트워크 속도가 느려지기 때문에 웹 사이트를 접속하는 고객이 주로 어느 위치에 있는가가 Region을 선택하는 중요한 고려 사항이 될 수 있다.

+) 참고
서울 Region은 2016년에 개설되었다.
현재 기준으로 (2021년 2월) 가용영역은 총 4개가 존재한다.

+)
한국을 기준으로 aws 각 region과의 네트워크 속도를 측정할 수 있는 사이트이다.
서울 > 오사카 > 도쿄 순으로 속도가 빠른 것을 알 수 있다.
http://www.cloudping.info

+)
각 region 마다 같은 상품을 사용해도 가격이 다르다는 점이다.
투자의 문제일 수도 있고, 환율의 문제일 수도 있으니 지역을 선택하기 전에 꼭 확인해보아야 한다.
그러므로 지역은 중요한 이슈 중 하나이다.

### 가용 영역(avaliability zone)

자연재해 발생 시 백업의 용도로 하나의 region에 여러 az가 존재한다.
하나의 지역 안에는 여러 가용영역으로 나뉘어져 있으며, 각 건물들 간에 인터넷 보다 더 빠른 전용 선으로 직접 연결되어 있다.
마치 같은 건물에 있는 것 처럼 빠른 속도로 데이터를 주고 받을 수 있다.

같은 지역 안에 존재하는 서로 다른 가용 영역끼리 데이터를 주고 받을 수 있지만, 서로 다른 지역에 있는 것들과는 데이터를 주고 받을 수 없다.
아예 주고 받을 수 없는 건 아니지만 인터넷 선을 통해서 느리게 주고 받을 수 있다.

ex)

region 명             az 명  연결           az 명
--------------------  -----  -------------  -----
region1 : 도쿄        az1    <- 전용 선 ->  az2  
<- 인터넷 선 ->                                  
region2 : 캘리포니아  az1    <- 전용 선 ->  az2  

## AWS EC2

EC2(Elastic Compute Cloud)는 독립된 컴퓨터를 임대해주는 서비스이다.

### EC2 생성 및 삭제

인스턴스란, 컴퓨터 한대라고 이해하면 된다. ex) 3대의 컴퓨터를 임대했다 == 인스턴스 3개를 만들었다.
원래대로라면 컴퓨터를 구매하고 설치했어야 할 과정이지만 단 1분만에 인스턴스를 만들 수 있다.
또한, 원격제어로 접속하여 미국 캘리포니아에 설치한 인스턴스를 내 자리에 있는 컴퓨터처럼 사용할 수도 있다.

- 인스턴스 생성 방법
 운영체제 선택 > cpu/memory 선택 > 인스턴스 갯수 설정(1개) > 저장장치 설정 (8GB) > 태그 인스턴스 (컴퓨터 이름 지정) > 컴퓨터 보안 설정 (보안 그룹 이름 설정) > 지정한 내용을 최종적으로 review하고 launch 버튼 > 비밀키 설정 (새로 만든 인스턴스에 접속하기 위한 비밀번호를 지정하기 위한 것임.) > key pair name을 지정하면 비밀번호가 파일로 다운받아짐.

- 인스턴스 일시 중지 및 삭제 방법
 아주 간단하게 인스턴스를 일시 중지 혹은 삭제할 수 있으며, 과금이 되지 않는다.
 EC2 > 삭제할 인스턴스 선택 > 오른쪽 클릭 > instance status > stop / terminate 선택
 
 ### EC2 인스턴스 타입

EC2 인스턴스는 가격과 관련이 있기 때문에 중요한 요소 중 하나이다.

- 운영체제 선택
 인스턴스를 생성할 때 지정하는 운영체제는 크게 두가지로 나뉜다.

* unix계열 : amazon linux, redhat , buse Linux, Ubuntu
* window : Windows Server 2012 R2 Base
 1년간 무료로 사용 가능하며, 이외의 것들은 유료이다.

- 인스턴스 타입 선택
 컴퓨터의 사양을 선택하는 것이라고 이해하면 된다.
 freetier만 1년간 무료로 사용할 수 있는 스펙이며, vCpus, Memory, Network Performance 등을 지정할 수 있다.
 
 ### EC2 가격정책

EC2의 가격정책에는 여러가지가 있으며, aws 페이지에서 가격을 미리 살펴볼 수 있다.
가격 정책은 시간당 계산하고 있으며, 자신의 상황에 따라서 현명하게 선택해야 한다.

- 온 디맨드 인스턴스
 필요할 때마다 켜고 끄는(온디맨드) 인스턴스이다.
 운영체제별로 가격 정책이 다름

- 예약 인스턴스
 할인권을 구매하는 것이라고 생각하면 된다.
 예를 들어 일년간 인스턴스를 한번도 끄지 않고 사용할 예정이라면 1년권을 구매할 수도 있고, 혹은 3년치 할인권을 살 수도 있다.
 일반 가격보다 훨씬 더 저렴하게 쓸 수 있으며, 최대 75% 할인된 가격으로 사용할 수 있다.
 물론 온디맨드 인스턴스처럼 켜고 끄는 것을 지정할 수 있다.
 다만, 인스턴스를 할인권 기간만큼 사용하지 않는다면 혜택을 못 누리기 때문에 잘 생각하고 사야된다.

- 스팟 인스턴스
 인스턴스를 여러개 생성한 유저에게 유리한 가격 정책이다.
 일지 중지 상태인 컴퓨터가 많을 때는 그 가격이 저렴해지지만, 가용중인 인스턴스가 많을 때는 일반 가격보다 더 비싸질 수 있다.
 요금이 주가처럼 가변적인 것이 특징이다.
 온디맨드 인스턴스처럼 켜고 끄는 것을 지정할 수 있다.

### EC2 인스턴스 장치 설정

몇개의 인스턴스를 설정할 것인지 지정 가능하다.
aws 초보자들이 실수를 많이 해서 생성할 수 있는 컴퓨터 갯수가 제한되어 있다.
서비스 론칭 등의 어떤 이벤트가 있거나 할때 aws 측에 요청하여 한도를 늘릴 수 있다.

- EC2 인스턴스 장치 설정 항목
  인스턴스 타입 지정 : 스팟 인스턴스 or not
  shutdown 시 event 설정 : 일시정지(stop) or 삭제(terminate)
  삭제 시 방지 대책 : 백업 사용 or not
  상세 모니터링 저장 유무 등등..

- 저장 장치 추가 (EBS: Elastic Block Store)
  CPU : 리눅스는 기본 8기가, 윈도우는 기본 30기가 (30GB까지 무료)
  IOPS : 저장장치의 속도
  Delete on Termination : 만든 인스턴스가 삭제가 되면 해당 저장장치도 함께 삭제 or not
  체크 시, 인스턴스가 삭제가 되면 저장장치도 함께 삭제 (내장하드)
  체트 해제 시, 인스턴스가 삭제되어도 저장장치는 남아있다 (외장하드) / 저장장치가 남아있어서 과금이 될 수도 있으므로 유의!

### EC2 태그와 보안그룹

- EC2 태그
  key-value 형식으로 기입한다.
  해당 인스턴스가 어떤 역할인지, 누가 관리하는지 등을 태그에 기록할 수 있다.

  ex)
  | key | value |
  |----|-------|
  | Name | Web Server |
  | 관리자 | Eunji Song |
  | Type | real |

- EC2 보안그룹
  어떤 방식의 접속만 허용할 것인지, 방화벽과 같은 역할을 한다.
  자신이 어떤 인스턴스를 만들지에 따라 보안 정책이 달라진다.
  시큐리티 그룹 내 그룹 명과 설명이 중복되면 안된다!

Assing a security group (택 1) : Create new security group(선택) / Select an existing security group
security group name : web
Description : for web server
Type :

- SSH(Secure Shell) : 리눅스계열의 원격제어 방식
- HTTP : 웹 브라우저를 통해서 접속하는 방식

Port :
Source :

- My IP (내가 현재 접속한 IP로만 접속이 됨)
- Anywhere (어떤 IP라도 접속이 됨)

### EC2 인스턴스 비밀번호 생성

인스턴스의 네트워크를 통해서 접속할 때 사용할 비밀번호를 지정하는 것이다.
비밀번호의 이름을 지정하고 Download key pair 버튼을 클릭하면 아마존에서 비밀번호(private key)를 랜덤하게 생성하여 파일로 다운로드 한다.
비밀번호 다운로드가 완료되면 생성한 인스턴스에도 동일한 비밀번호(public key)를 생성한다.
그리하여, 해당 인스턴스에 접속하려면 다운로드 한 비밀번호를 가지고 접근해야 한다.
문제는 파일로 저장된 비밀번호는 탈취될 가능성이 있으므로, 해당 비밀번호 파일을 잘 관리해야 한다는 점이다.
비밀번호를 분실하면 다시 복구해주지 않으므로 소중하게 관리해야 한다.

### EC2 리눅스 인스턴스 접속 (OSX)

인스턴스 오른쪽 클릭 > connect > A standalone SSH client 선택
아래에 적혀있는 메뉴얼 대로 실행하면 됨.

1. terminal 오픈
2. 비밀번호 파일의 권한을 지정한다. (특정 사용자만 접근하여 읽을 수 있도록 지정하는 것)

```
chmod 400 {파일 path}
```

3. AWS에서 인스턴스의 ip와 접속 커맨드를 제공해준다.
  인스턴스의 ip에 접속하려면 id와 password가 필요한데, ubuntu가 id, aws_password.pem파일을 password로 사용한다.
  (ubuntu는 인스턴스를 작성할 때 자동으로 생성되는 id이며, ubuntu로 인스턴스를 만들지 않았다면 ec2-user 일 것)

```
// 인스턴스 접속
ssh -i "aws_password.pem" ubuntu@{인스턴스가 위치하고 있는 ip}
```

### 리눅스 인스턴스에서 웹서버 사용

apt-get: osx homebrew 같이 어떤 프로그램을 설치하도록 도와주는 프로그램

```
// apache2 설치
sudo apt-get install apache2
```

인스턴스를 누르면 페이지 아래쪽에 인스턴스에 대한 상세 내용과 함께 DNS가 표시됨.
해당 DNS로 접속하면 페이지(./var/www/html/index.html)가 보여짐.

security group에 web이 설정되어 있음. (방화벽 설정)

### EC2 AWS Marketplace (Wordpress)

AMI란, 아마존 머신 이미지(Amazon Machine Image)의 약자로, 소프트웨어 환경설정 내용, OS, 애플리케이션 서버, 애플리케이션 등이 포함된 템플릿이다.

- My AMIs : 내가 만든 인스턴스를 이미지화 한 것
- AWS Marketplace, Community AMIs : 다른 사람이 작성한 인스턴스 이미지를 다운받을 수 있는 곳

<AWS Marketplace에서 다운받은 이미지로 인스턴스 만들기 >
AWS Marketplace에서 Wordpress(HVM)을 선택 > region 선택 후 continue 클릭 > 상세 조건 선택(region, instance type, security group) > Launch with 1 click 클릭

### EC2 Scalability - Scale Up

#### 가상머신

가상머신이란, 소프트웨어로 만든 기계를 말한다.
우리가 일반적으로 사용하는 컴퓨터는 물리적 기계 위에 운영체제를 세운 것이라면,
가상머신은 일반 컴퓨터의 운영체제 위해 가상머신을 세워 새로운 운영체제를 설치해 운영한다.
ex) 맥북(mac os)에서 은행업무를 보기 위하여 가상머신으로 window를 설치하는 케이스

가상머신 : VMWare, Virtual Box, Parallels

start-up : 저렴한 인스턴스를 생성해서 사용할 수 있음 (물리적인 컴퓨터를 쪼개서 가상머신을 설치)
대기업 : 스펙이 좋은 인스턴스를 생성해서 사용할 수 있음 (물리적인 컴퓨터 여러대를 연결하여 가상머신을 설치)

한대의 컴퓨터에 딱 맞는 프로그램을 만든다면 직접 컴퓨터에 설치하는 것이 비용이나 처리 측면에서 효율적일 수 있다.
하지만 위의 케이스처럼 여러대의 컴퓨터를 사용해야 한다던지 한다면, 클라우드 컴퓨팅을 사용하는 것이 더 낫다.
클라우드 컴퓨팅 모델은 수요에 따라서 빠르게 대응할 수 있다.

#### Scale Up

인스턴스의 수요가 변화하면 그에 맞추어서 자동으로 Scale Up을 하거나 Scale Down을 한다.
인스턴스의 수요 : 유저 접속 수 (트래픽)

Scale Up : 더 좋은 스펙의 컴퓨터로 교체하는 것
Scale Down : Scale Up의 반대

#### 스트레스 테스트 준비

```
// 부하 발생기 다운로드
sudo apt-get install apache2-utils
```

#### 스트레스 테스트 시작

ab : apache bench라는 프로그램을 실행하겠다
-n : 몇명이 접속할 것인가
-c : 동시접속
접속주소 : 접속할 주소의 URL, 뒤에 꼭 슬래쉬를 붙여줘야 함

```
ab -n 400 -c 1 {접속 주소}/
```

부하가 커질 수록(트래픽이 높아질수록) 처리속도가 느려지는 것이 확인 되었다. (프로그램의 퀄리티가 떨어짐)

#### Elastic IP

AWS에서 Public IP는 인스턴스를 껐다 다시 켜면 변화한다.

Elastic IP란, 고정 아이피를 말한다.
Elastic IP를 부여받으면 IP가 변화하는 문제를 해결할 수 있다.
Elastic IP는 유료임!!

- Elastic IP 생성 : Elastic IPs > Allocate New Address
- Elastic IP 부여 : Elastic IPs 오른쪽 클릭 > Associate Address > 인스턴스 선택 > Associate
- Elastic IP 해제 : Elastic IPs 오른쪽 클릭 > Release Addresses

### EC2 Scalability - Scale Out (ELB)

#### Scale Out 이란?

Scale Out 이란, 여러 대의 컴퓨터가 서로 협력해서 목표를 달성하는 것을 말한다.

#### Scale Out의 흐름

일반적인 웹 애플리케이션은 다음과 같은 흐름으로 진행된다.
Web Server -> Middle Ware(웹 애플리케이션이 동작하는 logical한 부분을 담당) -> Database

Scale Out에서는 이러한 흐름 가운데 일부를 떼어내 다른 컴퓨터에서 수행한다.
예를 들어, 다음과 같이 말이다.

- 컴퓨터 A : Web Server -> Middle Ware
- 컴퓨터 B : Database

사용자의 입장에서는 바뀐 점이 없지만, 이렇게 함으로서 컴퓨터의 입장에서는 Scalabiltiy가 좋아졌다.
협동해서 일하기 때문에 성능상으로 더 좋아졌지만 복잡해졌다는 단점이 있다.

ex) Database의 속도가 느려졌다면, Database Server를 더 늘리면 된다.

- 컴퓨터 A : Web Server
- 컴퓨터 B : Middle Ware
- 컴퓨터 C : Database
- 컴퓨터 D : Database

ex) 이번엔 Middle Ware에서 속도가 느려졌다면, Middle Ware를 더 늘리면 된다.

- 컴퓨터 A : Web Server
- 컴퓨터 B : Middle Ware
- 컴퓨터 C : Middle Ware
- 컴퓨터 D : Database
- 컴퓨터 E : Database

다만 Web Server는 여러개로 늘릴 수 없다.
단일 DNS, 단일 IP로 이용자가 접속할 수 없기 때문이다. (DNS는 전화번호부와 같아서 DNS로 검색하여 연결되어 있는 IP를 찾아내 접속한다.)
하지만, DNS 서버의 설정을 변경해서 특정 이용자가 접속했을 때는 특정 IP로 접속하게끔 해서 Web Server를 확장할 수 있다.

ex) DNS 서버의 설정을 변경해 복수개의 IP와 연결을 했다면

- DNS 두개의 IP와 연결
- 컴퓨터 A : Web Server / 첫번째 IP (UserId : ~5000)
- 컴퓨터 B : Web Server / 두번째 IP (UserId : 5001 ~)
- 컴퓨터 C : Middle Ware
- 컴퓨터 D : Middle Ware
- 컴퓨터 E : Database
- 컴퓨터 F : Database

Load Balancer를 사용해서 복수의 Web Server에 부하를 분산시킬 수 있다.
이때 유저가 접속하는 IP는 Load Balancer의 IP임.

#### ELB 사용시 주의 사항

ELB란, Elastic Load Balancer의 약자이다.

예를 들어 ELB를 통해 다음과 같은 흐름으로 작업이 수행된다고 해보자.
ex)
ELB -> 컴퓨터 A (Web Server -> Middle Ware -> Database)
ELB -> 컴퓨터 B (Web Server -> Middle Ware -> Database)

유저 A는 ELB에 의해 컴퓨터 A에 접속하여 글을 남겼고,
유저 B는 ELB에 의해 컴퓨터 B에 접속하여 글을 남겼다.

여기서 문제는 컴퓨터 A와 B는 같은 애플리케이션인데 입력한 값이 각기 달리 표시된다는 점이다. (다른 Database를 가지고 있기 때문에)
Scale Out을 사용하여 Database를 따로 분리하여 컴퓨터 A와 B가 단일 Database를 바라보도록 하면 문제는 해결된다!

ex)
ELB -> 컴퓨터 A (Web Server -> Middle Ware) -> 컴퓨터 C (Database)
ELB -> 컴퓨터 B (Web Server -> Middle Ware) -> 컴퓨터 C (Database)
